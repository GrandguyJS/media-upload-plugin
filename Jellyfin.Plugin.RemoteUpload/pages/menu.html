<div data-role="page" class="page type-interior pluginConfigurationPage"
	 data-require="emby-button,emby-select,emby-checkbox">
	<div data-role="content">
		<div class="content-primary">
			<div class="content-primary">
				<form id="RemoteUploadForm" enctype="multipart/form-data" action="/mediaupload/upload">
                    <div class="inputContainer">
						<h2>Remote Upload</h2>
						<input type="file" name="files" required multiple id="uploadfile" is="emby-input" value="Upload file"/>
						<div class="fieldDescription">Uploading to <span id="uploaddir"></span></div>
                    </div>
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button" id="uploaddirsubmit">
                            <span id="progress">Upload</span>
                        </button>
                    </div>
                </form>
			</div>
        </div>
    </div> 	
	<script>
		var RemoteUploadConfig = {
			pluginUniqueId: 'b5a2d6b3-c5f4-4f88-aed4-5f3e9877d0a6',
			uploaddir: ''
		};
		
		Dashboard.showLoadingMsg();
		ApiClient.getPluginConfiguration(RemoteUploadConfig.pluginUniqueId).then(function (config) {
			document.getElementById("uploaddir").textContent = config.uploaddir;
			RemoteUploadConfig.uploaddir = config.uploaddir
			Dashboard.hideLoadingMsg();
		});

		document.querySelector("#RemoteUploadForm")
			.addEventListener("submit", async function(e) {
				e.preventDefault();
				document.querySelector(".button-submit").style["#292929"]

				let formElement = document.getElementById("RemoteUploadForm");
				let formData = new FormData(formElement);
				let url = formElement.action;

				let progess = document.getElementById("progress");

				const chunk_size = 28000000; // 28 MB in Bytes


				for (let [key, file] of formData.entries()) {
					let chunk_index = 0;
					let start = 0;

					if (file instanceof File) { 
						while (start < file.size) {
							const chunk = file.slice(start, start+chunk_size);
							let chunk_form = new FormData();
							chunk_form.set("file", chunk, file.name)
							chunk_form.set("chunkIndex", chunk_index)
							chunk_form.set("totalChunks", Math.ceil(file.size / chunk_size))

							// Request
							try {
								console.log(url, chunk_form);
								const res = await fetch(url, {method: 'POST', body: chunk_form});
								if (res.ok) {
									console.log("Successfully saved chunk " + chunk_index);
								}
							}
							catch (error) {
								console.log(`ERROR: ${error}`);
								break;
							}

							let progress_value = ((chunk_index+1)/Math.ceil(file.size / chunk_size))*100
							progress.textContent = file.name + " " + progress_value.toString() + "%"
							start += chunk_size
							chunk_index++;
						}

					}
				}
				progress.textContent = "Upload"
				document.querySelector(".button-submit").style["#00a4dc"]
				document.getElementById("uploadfile").value = '';
			})
	</script>
</div>