<div data-role="page" class="page type-interior pluginConfigurationPage"
	 data-require="emby-button,emby-select,emby-checkbox">
	<div data-role="content">
		<div class="content-primary">
			<div class="content-primary">
				<form id="RemoteFileUploadForm" enctype="multipart/form-data" action="/mediaupload/upload">
                    <div class="inputContainer">
						<h2>Upload file</h2>
						<input type="file" name="files" required multiple id="uploadfile" is="emby-input" value="Upload file"/>
                    </div>
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button" id="uploaddirsubmit">
                            <span id="progress_file">Upload</span>
                        </button>
                    </div>
                </form>
				<form id="RemoteURLUploadForm" enctype="multipart/form-data" action="/mediaupload/upload_url">
                    <div class="inputContainer">
						<h2>Download from URL</h2>
						<input type="text" name="url" required id="uploadurl" is="emby-input" placeholder="https://download.com/file.mp4"/>
                    </div>
                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button" id="uploadurlsubmit">
                            <span id="progress_url">Upload</span>
                        </button>
                    </div>
                </form>
			</div>
        </div>
    </div> 	
	<script>
		var RemoteUploadConfig = {
			pluginUniqueId: 'b5a2d6b3-c5f4-4f88-aed4-5f3e9877d0a6',
		};

		let progress = document.getElementById("progress_file");
		
		document.querySelector("#RemoteFileUploadForm")
			.addEventListener("submit", async function(e) {
				e.preventDefault();

				let formElement = document.getElementById("RemoteFileUploadForm");
				let formData = new FormData(formElement);
				let url = formElement.action;

				const chunk_size = 28000000; // 28 MB in Bytes

				for (let [key, file] of formData.entries()) {
					let chunk_index = 0;
					let start = 0;

					if (file instanceof File) { 
						while (start < file.size) {
							const chunk = file.slice(start, start+chunk_size);
							let chunk_form = new FormData();
							chunk_form.set("file", chunk, file.name)
							chunk_form.set("chunkIndex", chunk_index)
							chunk_form.set("totalChunks", Math.ceil(file.size / chunk_size))

							// Request
							try {
								const res = await fetch(url, {method: 'POST', body: chunk_form});
								if (res.ok) {
									console.log("Successfully saved chunk " + chunk_index);
									let progress_value = ((chunk_index+1)/Math.ceil(file.size / chunk_size))*100
									progress.textContent = file.name + " " + progress_value.toString() + "%"
									start += chunk_size
									chunk_index++;
								}
								else {
                                    const result = await res.json();
                                    progress.textContent = result.message || 'Upload failed!';
                                    return;
                                }
								
							} catch (error) {
								progess.textContent = "Upload failed!"
								console.log('Error:', error);
								return;
							}
						}
					}
				}
				/* If upload finished successfully */
				progress.textContent = "Upload finished";
				document.getElementById("uploadfile").value = "";
				return;
			});

			document.getElementById("uploadfile").addEventListener("change", (event) => {
				progress.textContent = "Upload";
			});

			/* Upload from URL */
			let progress_url = document.getElementById("progress_url");
			document.querySelector("#RemoteURLUploadForm").addEventListener("submit", async function(e) {
				e.preventDefault();
				
				let formElement = document.getElementById("RemoteURLUploadForm");
				let formData = new FormData();
				formData.set("url", document.getElementById("uploadurl").value);

				let url = formElement.action;

				try {
					const res = await fetch(url, {method: "POST", body: formData});
					if (res.ok) {
						progress_url.textContent = "Download has started..."
						document.getElementById("uploadurl").value = "";
						return;
					}
					else {
						const result = await res.json();
						progress_url.textContent = result.message || "Download failed!";
						return;
					}
				}
				catch (error) {
					progress_url.textContent = "Download failed!"
					return;
				}
			});

			document.getElementById("uploadurl").addEventListener("change", function() {
				progress_url.textContent = "Upload";
			})
			/* Version 1.1 */
	</script>
</div>